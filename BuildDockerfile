FROM continuumio/miniconda3
# Use host user id to be capable to use -v $(PWD):/haystackapi
ARG UID=1000
RUN adduser --disabled-password --uid ${UID} --gecos '' haystackapi
RUN chmod go+rw -R /usr/local /opt/conda
RUN conda install -y make
USER haystackapi
RUN conda init bash
COPY . /haystackapi
USER root
RUN chown ${UID}:${UID} -R /haystackapi
USER haystackapi
WORKDIR /haystackapi
ENV VENV=docker-haystackapi
RUN make configure
RUN echo "conda activate docker-haystackapi" >>~/.bashrc

ENTRYPOINT ["/opt/conda/bin/make"]
CMD ["help"]
