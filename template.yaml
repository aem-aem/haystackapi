# Use the `make build`.

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: An implementation of Haystack protocol
# See https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html

# More info about Parameters: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html#parameters-section-structure-requirements
# Set the parameter with --parameter-overrides: https://docs.aws.amazon.com/cli/latest/reference/cloudformation/deploy/index.html#deploy
Parameters:
  HaystackProvider:
    Type: String
    Description: Enter the Haystack provider class name. See src/providers
  HaystackURL:
    Type: String
    Default: grid.zinc
    Description: If the provider is `providers.url`, enter the URL to load Haystack file
  LOGLEVEL:
    Type: String
    Default: WARNING
    AllowedValues:
      - ERROR
      - WARNING
      - INFO
      - DEBUG
    Description: Enter ERROR, WARNING, INFO or DEBUG.

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Runtime: python3.7
    Timeout: 30
    Environment:
      Variables:
        DEBUGGING: false
        NOCOMPRESS: true
        LOGLEVEL: { "Ref" : "LOGLEVEL" }
        HAYSTACK_PROVIDER: { "Ref" : "HaystackProvider" }
        HAYSTACK_URL: { "Ref" : "HaystackURL" }
    Layers:
      - !Ref BaseLayer
      - !Ref ParquetLayer
      - !Ref HSZincLayer

Resources:
  BaseLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: layers/base
      CompatibleRuntimes:
        - python3.7
        - python3.8
      Description: Custom Haystack Zinc libraries
      LayerName: base
      LicenseInfo: BSD 2
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: python3.7

  # Because the snappy module never import the libsnappy.so.1,
  # I must create a Makefile to build this layer
  ParquetLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: .
      CompatibleRuntimes:
        - python3.7
        - python3.8
      Description: Parquet loader layers
      LayerName: parquet
      LicenseInfo: BSD 2
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  HSZincLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: .
      CompatibleRuntimes:
        - python3.7
        - python3.8
      Description: Custom Haystack Zinc libraries
      LayerName: HSZinc
      LicenseInfo: BSD 2
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: makefile

  About:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: ping.ping
      Description: Implement the Haystack `About` api
      Policies:
        - AWSLambdaBasicExecutionRole
        - AWSLambdaReadOnlyAccess
        - AWSXrayWriteOnlyAccess
      Tracing: Active
      Events:
        HaystackAboutGET:
          Type: Api
          Properties:
            Path: /about
            Method: get
        HaystackAboutPOST:
          Type: Api
          Properties:
            Path: /about
            Method: post
#
#  Ops:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.ops
#      Description: Implement the Haystack `Ops` api
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        HaystackAboutGET:
#          Type: Api
#          Properties:
#            Path: /ops
#            Method: get
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /ops
#            Method: post
#
#  Formats:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.formats
#      Description: Implement the Haystack `Formats` api
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        HaystackAboutGET:
#          Type: Api
#          Properties:
#            Path: /formats
#            Method: get
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /formats
#            Method: post

#  Read:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.read
#      Description: Implement the Haystack `read` api
#      Role: arn:aws:iam::695980681400:role/cdh_poc1paris_59238
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        HaystackAboutGET:
#          Type: Api
#          Properties:
#            Path: /read
#            Method: get
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /read
#            Method: post

#  Nav:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.nav
#      Description: Implement the Haystack `nav` api
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        HaystackAboutGET:
#          Type: Api
#          Properties:
#            Path: /nav
#            Method: get
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /nav
#            Method: post

#  WatchSub:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.watch_sub
#      Description: Implement the Haystack `watch_sub` api
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        #        HaystackAboutGET:
#        #          Type: Api
#        #          Properties:
#        #            Path: /watch_sub
#        #            Method: get
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /watch_sub
#            Method: post
#
#  WatchUnsub:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.watch_unsub
#      Description: Implement the Haystack `watch_unsub` api
#      # Function's execution role
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        #        HaystackAboutGET:
#        #          Type: Api
#        #          Properties:
#        #            Path: /watch_unsub
#        #            Method: get
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /watch_unsub
#            Method: post
#
#  WatchPoll:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.watch_poll
#      Description: Implement the Haystack `watch_poll` api
#      # Function's execution role
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        HaystackAboutGET:
#          Type: Api
#          Properties:
#            Path: /watch_poll
#            Method: get
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /watch_poll
#            Method: post
#
#  PointWrite:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.point_write
#      Description: Implement the Haystack `point_write` api
#      # Function's execution role
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /point_write
#            Method: post

#  HisRead:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.his_read
#      Description: Implement the Haystack `his_read` api
#      # Function's execution role
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Layers:
#        - !Ref ParquetLayer
#      Events:
#        HaystackAboutGET:
#          Type: Api
#          Properties:
#            Path: /hisRead
#            Method: get
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /hisRead
#            Method: post
#
#  HisWrite:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.his_write
#      Description: Implement the Haystack `his_write` api
#      # Function's execution role
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Layers:
#        - !Ref ParquetLayer
#      Events:
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /hisWrite
#            Method: post
#
#  InvokeAction:
#    Type: AWS::Serverless::Function
#    Properties:
#      CodeUri: src/
#      Handler: haystackapi_lambda.invoke_action
#      Description: Implement the Haystack `invoke_action` api
#      # Function's execution role
#      Policies:
#        - AWSLambdaBasicExecutionRole
#        - AWSLambdaReadOnlyAccess
#        - AWSXrayWriteOnlyAccess
#      Events:
#        HaystackAboutPOST:
#          Type: Api
#          Properties:
#            Path: /invokeAction
#            Method: post

#Outputs:
#  # ServerlessRestApi is an implicit API created out of Events key under Serverless::Function
#  # Find out more about other implicit resources you can reference within SAM
#  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
#  AboutAPI:
#    Description: "Haystack `about` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/about"
#  AboutFunction:
#    Description: "Haystack `about` API"
#    Value: !GetAtt About.Arn
#
#  OpsAPI:
#    Description: "Haystack `ops` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/ops"
#  OpsFunction:
#    Description: "Haystack `ops` API"
#    Value: !GetAtt Ops.Arn
#
#  FormatsAPI:
#    Description: "Haystack `formats` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/formats"
#  FormatsFunction:
#    Description: "Haystack `formats` API"
#    Value: !GetAtt Formats.Arn
#
#  HisWrite:
#    Description: "Haystack `his_write` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/his_write"
#  HisWriteFunction:
#    Description: "Haystack `his_write` API"
#    Value: !GetAtt HisWrite.Arn
#
#  InvokeAction:
#    Description: "Haystack `invoke_action` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/invoke_action"
#  InvokeActionFunction:
#    Description: "Haystack `invoke_action` API"
#    Value: !GetAtt InvokeAction.Arn
#
#  NavAction:
#    Description: "Haystack `nav` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/nav"
#  NavFunction:
#    Description: "Haystack `nav` API"
#    Value: !GetAtt Nav.Arn
#
#  PointWriteAction:
#    Description: "Haystack `point_write` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/point_write"
#  PointWriteFunction:
#    Description: "Haystack `point_write` API"
#    Value: !GetAtt Ops.Arn
#
#  ReadAction:
#    Description: "Haystack `read` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/read"
#  ReadFunction:
#    Description: "Haystack `read` API"
#    Value: !GetAtt Read.Arn
#
#  WatchPollAction:
#    Description: "Haystack `watch_poll` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/watch_poll"
#  WatchPollFunction:
#    Description: "Haystack `watch_poll` API"
#    Value: !GetAtt WatchPoll.Arn
#
#  WatchSubAction:
#    Description: "Haystack `watch_sub` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/watch_sub"
#  WatchSubFunction:
#    Description: "Haystack `watch_sub` API"
#    Value: !GetAtt WatchSub.Arn
#
#  WatchUnsubAction:
#    Description: "Haystack `watch_unsub` API"
#    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/src/watch_unsub"
#  WatchUnsubFunction:
#    Description: "Haystack `watch_unsub` API"
#    Value: !GetAtt WatchUnsub.Arn
